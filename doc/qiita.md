# はじめに
この記事では空間系エフェクターの一つであるリバーブの実装、特に畳み込み演算を用いたリバーブの実装を行う。

# リバーブの種類について
リバーブ（残響）が何なのか分からない人の為に導入を書くけども、日常生活の中色んな場所で聞ける。
風呂場で叫び声を上げた時とかの残響が多分一番良く例に上げられる事象だけど、会津若松駅前の富士の湯に行ったことある人とかはこの例えが良くわかると思う。
知らないおっさんが隣で歌ってた時は地獄だったけど、声にエフェクトがかかって歌がうまくなった様に感じる事もある。
カラオケで気分が乗って声にリバーブエフェクトを付けた事、一度はあるのでは。  
この残響をハードウェア、ソフトウェア上で実現する為に色んな種類のリバーブが今までに提案されてる。
結構深い歴史があるみたいだけど趣旨とは外れるからさらっと種類について以下で説明する。

## Hall
一番ポピュラーな残響効果。
巨大なコンサートホールを再現した残響効果をもたらす様なリバーブの事。
と言っても実際にコンサートホールを借りて録音なんてとても出来ないので、基本的にはデジタルプラグイン上で実現する。

## Room
上のHallリバーブと合わせて箱物リバーブだとか呼ばれてるらしい。
Hallと同じ様な残響効果だが、名前の通りホールよりは狭いスタジオを模したリバーブ効果を指している。
上と同じくプラグイン上で使われている。

## Plate
1950年代に誕生。名前から直感的に明らかな様に、鉄板の揺れを利用してリバーブを実現する手法。
デジタル上で再現したプラグインも今なお複数存在している。
ただの鉄板と言っても残響効果を得る為には人の身長か畳一畳分くらいの大きさが必要で、非常に大掛かりな装置になる。
当時は高価だった為金持ちの人しか手に入らなかった模様。

## Spring
金属製のバネに振動を加え、その共振で残響効果を得るもの。
1960年に提案、制作された。
Plateリバーブとは違い、比較的狭いスペースでも残響が実現可能。デジタルなリバーブが主流になる前はカラオケの機材にも使われていたとか。
現在でもギターを触ってる人にとっては結構ポピュラーな存在らしい。
アナログ特有の暖かい残響音が得られるのだとか。

## Algorithmic
実際の環境を実現する為に幾つかの（時には膨大な）パラメータを与えて反響を実現する手法。
多くのDigital Audio Workstation (DAW)上のプラグインで用いられている。
色んなツマミを弄って（パラメータを変えて）音を変えるイメージ。
あくまでもパラメータを用いて現実をシミュレートするものの為、クオリティが非常にピンキリ。
現実に存在しない様な環境の反響を実現出来る点には可能性を感じる。
最近流行りのEDM（最近ようやく廃れてきた？）で聞く様な「スコォォォォォォオオオオアアアアアアアアンンンンンンンンンンヌ」って音はこれじゃないと無理っぽい。

## Convolution
Algorithmic Reverbとは対称的に、こちらは実在する環境を元に反響を生成する手法。
具体的には実在する環境の「インパルス応答」と元の音データを畳み込んでリバーブを生成する。
検索してみるとよく上のAlgorithmic Reverbとどっちを使うべきなのかって議論を見かける。
反響を再現したい部屋のインパルス応答が存在すれば実際にその部屋で音を鳴らした時の反響をPC上で再現可能。
インパルス応答は以下のサイトの様に配布されている場所も。（全国各地の教会とか大学の講堂）
http://www.openairlib.net/auralizationdb

非常に高品質なリバーブを再現する事もできるが、
そのまま愚直に畳み込み演算を行うと膨大な計算時間が必要になる。
例えばサンプリング周波数48000Hzで1秒のインパルス応答を畳み込む場合、 1サンプルの出力を得る為には1秒間に48000回*48000回=23億400万回の積和演算回数が必要。
高速フーリエ変換（FFT）と逆高速フーリエ変換(iFFT)を用いて実現する。  
理論的に数学知識モリモリあつしって感じで面白そうだったので本記事ではこれを実装してみる。


# 実装する上で理解しておく必要がある理論
## インパルス応答

## 畳み込み演算

## FFT


# 実装

## Reference
https://www.g200kg.com/jp/docs/dic/convolutionreverb.html  
http://www.ari-web.com/service/soft/reverb-4.htm  
http://yukara-13.hatenablog.com/entry/2013/12/20/094926  
https://en.wikipedia.org/wiki/Reverberation  
https://en.wikipedia.org/wiki/Fast_Fourier_transform  
http://brian-doyle.com/2011/10/28/convolution-vs-algorithmic-reverbs/  
